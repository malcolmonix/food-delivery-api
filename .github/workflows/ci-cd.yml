name: Food Delivery API CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: malcolmonix/food-delivery-api

permissions:
  contents: read
  packages: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Test GraphQL Schema
      env:
        CI: true
        NODE_ENV: test
      run: |
        # Start the server in background for testing
        echo "Starting server in test mode..."
        npm start &
        SERVER_PID=$!
        
        # Wait for server to start
        echo "Waiting for server to initialize..."
        sleep 10
        
        # Run the test script
        echo "Running GraphQL endpoint tests..."
        if npm test; then
          echo "‚úÖ All tests passed"
        else
          echo "‚ùå Tests failed"
          kill $SERVER_PID 2>/dev/null || true
          exit 1
        fi
        
        # Clean up
        kill $SERVER_PID 2>/dev/null || true
        echo "‚úÖ Test suite completed successfully"
  build:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to VPS
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          APP_DIR=/opt/food-delivery-api
          IMAGE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          CONTAINER_NAME="food-delivery-api"
          PORT=3003
          
          echo "üìÅ Preparing $APP_DIR"
          sudo mkdir -p "$APP_DIR"
          sudo chown "$USER":"$USER" "$APP_DIR"
          # Docker setup
          if ! command -v docker >/dev/null 2>&1; then
            curl -fsSL https://get.docker.com | sh
            sudo usermod -aG docker "$USER" || true
          fi
          cd "$APP_DIR"
          echo "üîê Logging into GitHub Container Registry"
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          echo "üì¶ Pulling image ${IMAGE}"
          docker pull ${IMAGE}
          echo "üõë Stopping existing container"
          docker stop $CONTAINER_NAME || true
          docker rm $CONTAINER_NAME || true
          echo "üöÄ Starting new container"
          docker run -d \
            --name $CONTAINER_NAME \
            --restart unless-stopped \
            -p $PORT:$PORT \
            -e NODE_ENV=production \
            -e PORT=$PORT \
            -e DB_FILE=/app/data/enatega.db \
            -v food_delivery_api_data:/app/data \
            ${IMAGE}
          # Health check
          echo "‚è≥ Waiting for app to boot..."
          sleep 25
          if curl -fsS http://localhost:$PORT/graphql \
            -H "Content-Type: application/json" \
            -d '{"query": "{ __typename }"}'; then
            echo "‚úÖ Food Delivery API deployment healthy"
            docker image prune -f || true
          else
            echo "‚ùå Health check failed; last logs:"
            docker logs --tail=200 $CONTAINER_NAME || true
            exit 1
          fi
          
          echo ""
          echo "üéâ Deployment completed successfully!"
          echo "üìç API available at: http://145.14.158.29:$PORT/graphql"
          echo "üê≥ Container: $CONTAINER_NAME"